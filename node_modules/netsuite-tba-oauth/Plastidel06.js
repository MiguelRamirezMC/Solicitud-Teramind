/**
* @NApiVersion 2.x
* @NScriptType Suitelet
* @NModuleScope SameAccount
*/
define(['N/encode', 'N/xml', 'N/file', 'N/render', 'N/search', 'N/ui/serverWidget', 'N/url', 'N/format', 'N/runtime'],
    /**
     * @param {encode} encode
     * @param {file} file
     * @param {render} render
     * @param {search} search
     * @param {message} message
     * @param {serverWidget} serverWidget
     */
    function (encode, xml, file, render, search, sw, url, format, runtime) {

        debugger;
        /**
         * Definition of the Suitelet script trigger point.
         *
         * @param {Object} context
         * @param {file} file
         * @param {ServerRequest} context.request - Encapsulation of the incoming request
         * @param {ServerResponse} context.response - Encapsulation of the Suitelet response
         * @Since 2015.2
         */

        function onRequest(context) {



            var request = context.request;
            var response = context.response;



            var d = new Date();
            var desde = request.parameters.custpage_desde || format.format({ value: getFirstDateOfMonth(d), type: format.Type.DATE });
            var hasta = request.parameters.custpage_hasta || format.format({ value: getLastDateOfMonth(d), type: format.Type.DATE });
            var report = runtime.getCurrentScript().getParameter({ name: 'custscript_num_reporte' });
            var title = runtime.getCurrentScript().getParameter({ name: 'custscript_title_reporte' }) + '| LOS ARCHIVOS SE GENERAN EN LA CARPETA (DOCUMENTOS / ARCHIVOS / GABINETE DE ARCHIVO / REPORTES ' + runtime.getCurrentScript().getParameter({ name: 'custscript_title_reporte' }).substring(0, 3) + ')';
            var idCarpeta = '';

            var form = sw.createForm({ title: title });
            //form.clientScriptModulePath = './606 CS.js';



            //-----------------------------------------------------------------------------------
            //-- Botones del formulario
            form.addSubmitButton({ label: 'Enviar' });
            //form.addButton({ id: 'custpage_btn_xls', label: 'XLS', functionName: 'openXLS' });
            //form.addButton({ id: 'custpage_btn_txt', label: 'Generar TXT', functionName: 'createAndSaveFile' });


            //-----------------------------------------------------------------------------------
            //-- definici�n del campos de filtros del formulario    	
            var field_desde = form.addField({
                id: 'custpage_desde',
                type: sw.FieldType.DATE,
                label: 'DESDE',
            });

            var field_hasta = form.addField({
                id: 'custpage_hasta',
                type: sw.FieldType.DATE,
                label: 'HASTA',
            });


            /* var field_generar_archivo = form.addField({
                 id: 'custpage_archivos',
                 type: sw.FieldType.CHECKBOX,
                 label: 'GENERAR ARCHIVO TXT?',
             });*/

            var field_generar_archivo_xls = form.addField({
                id: 'custpage_archivosxls',
                type: sw.FieldType.CHECKBOX,
                label: 'GENERAR ARCHIVO XLS?',
            });





            form.addField({
                id: 'custpage_num_reporte',
                type: sw.FieldType.TEXT,
                label: 'Text'
            }).updateDisplayType({
                displayType: sw.FieldDisplayType.HIDDEN
            }).defaultValue = report;

            //-----------------------------------------------------------------------------------
            //-- Campo obligatorios
            field_desde.isMandatory = true;
            field_hasta.isMandatory = true;

            //-----------------------------------------------------------------------------------
            //-- Layout de campos
            field_desde.updateLayoutType({ layoutType: sw.FieldLayoutType.OUTSIDEBELOW });
            field_hasta.updateLayoutType({ layoutType: sw.FieldLayoutType.OUTSIDEBELOW });
            //field_generar_archivo.updateLayoutType({ layoutType: sw.FieldLayoutType.OUTSIDEBELOW });
            field_generar_archivo_xls.updateLayoutType({ layoutType: sw.FieldLayoutType.OUTSIDEBELOW });


            //-----------------------------------------------------------------------------------
            //-- Definici�n de valores por defecto de campos
            field_desde.defaultValue = desde;
            field_hasta.defaultValue = hasta;

            //-------------------------------------------------------------------------------
            //-- Sublista de movimientos    
            var slLineas = form.addSublist({
                id: 'custpage_sublist_result',
                type: sw.SublistType.LIST,
                label: 'Resultados'
            });

            //-------------------------------------------------------------------------------
            //-- Definici�n de campos de la sublista de movimientos seg�n columnas busqueda    
            var searchId = 'customsearch_606_compras';
            var moreFilters = []; //log.debug('report', report);
            if (report == 606) {
                searchId = 'customsearch_606_compras';
                idCarpeta = 35;
                moreFilters =
                    /** [
                      [[['custbody_fecha_pago.custrecord_fecha_pago','onorafter',desde ], 'and', ['custcol_4601_witaxapplies','is','T']], 'or', [['trandate','onorafter' ,desde], 'and', ['custcol_4601_witaxapplies','is','F']]], 'and', 
                      [[['custbody_fecha_pago.custrecord_fecha_pago','onorbefore',hasta], 'and', ['custcol_4601_witaxapplies','is','T']], 'or', [['trandate','onorbefore',hasta], 'and', ['custcol_4601_witaxapplies','is','F']]]]; */
                    /**               
                                [
                                    [[
                                    ['custbody_fecha_pago.custrecord_fecha_pago','onorafter',desde ], 'and', 
                                        ['custcol_4601_witaxapplies','is','T']], 'or',
                                        [['trandate','onorafter' ,desde], 'and', ['custcol_4601_witaxapplies','is','F']]], 'and',
                                    	
                                    	
                                    [[
                                    ['custbody_fecha_pago.custrecord_fecha_pago','onorbefore',hasta], 'and', 
                                        ['custcol_4601_witaxapplies','is','T']], 'or', 
                                        [['trandate','onorbefore',hasta], 'and', ['custcol_4601_witaxapplies','is','F']]]];              
                    */
                    /** Eliminar filtro de facturas con retenciones pero sin pago */
                    [
                        [[
                            ['custbody_fecha_pago.custrecord_fecha_pago', 'onorafter', desde], 'and',
                            ['custcol_4601_witaxapplies', 'is', 'T']], 'or',
                        [['trandate', 'onorafter', desde]]], 'and',


                        [[
                            ['custbody_fecha_pago.custrecord_fecha_pago', 'onorbefore', hasta], 'and',
                            ['custcol_4601_witaxapplies', 'is', 'T']], 'or',
                        [['trandate', 'onorbefore', hasta]]]];

                /** Eliminar filtro de facturas con retenciones pero sin pago */
            } else if (report == 607) {
                searchId = 'customsearch_607_ventas';
                idCarpeta = 36;
                moreFilters = [
                    /**
                                    [['type', 'is', 'CustInvs'], 'and', ['custcol_4601_witaxapplies','is','T'] ,'and',
                                          ['custbody_fecha_ret','onorafter',desde ], 'and', ['custbody_fecha_ret','onorbefore',hasta]],
                                    'or',
                    
                                    [[['custcol_4601_witaxapplies','is','F'], 'or', ['type', 'noneof', 'CustInvs']],'and',
                                          ['trandate','onorafter',desde ], 'and', ['trandate','onorbefore',hasta]]
                    */
                    [
                        [[['custbody_fecha_ret', 'onorafter', desde], 'and', ['custcol_4601_witaxapplies', 'is', 'T']], 'or', ['trandate', 'onorafter', desde]]]

                    , 'and',

                    [
                        [[['custbody_fecha_ret', 'onorbefore', hasta], 'and', ['custcol_4601_witaxapplies', 'is', 'T']], 'or', ['trandate', 'onorbefore', hasta]]]
                ];

                // log.debug('Desde', desde);
                // log.debug('Hasta', hasta);
            } else if (report == 608) {
                idCarpeta = 38;
                searchId = 'customsearch_608_anulados';
                moreFilters = [['trandate', 'onorafter', desde], 'and', ['trandate', 'onorbefore', hasta]];
            } else if (report == 609) {
                idCarpeta = '39';
                searchId = 'customsearch_609_serv_ext';
                moreFilters = [
                    [[['custbody_fecha_pago.custrecord_fecha_pago', 'onorafter', desde], 'and', ['custcol_4601_witaxapplies', 'is', 'T']], 'or', [['trandate', 'onorafter', desde], 'and', ['custcol_4601_witaxapplies', 'is', 'F']]], 'and',
                    [[['custbody_fecha_pago.custrecord_fecha_pago', 'onorbefore', hasta], 'and', ['custcol_4601_witaxapplies', 'is', 'T']], 'or', [['trandate', 'onorbefore', hasta], 'and', ['custcol_4601_witaxapplies', 'is', 'F']]]];
            }

            var searchMov = search.load({ id: searchId });

            var firstFilters = searchMov.filterExpression;
            moreFilters.push('and');
            moreFilters.push(firstFilters);
            searchMov.filterExpression = moreFilters;

            var baseColumn = searchMov.columns;
            var columns = JSON.parse(JSON.stringify(searchMov.columns));

            var colCount = 0;
            columns.forEach(function (col) {
                var type = col.type != 'select' ? col.type : sw.FieldType.TEXT;
                var label = col.label;
                var colName = 'custpage' + (colCount++);

                slLineas.addField({ id: colName, type: type, label: label });
            });


            var line = 0;
            var contents = "";
            var datos = [];

            var fechaPago;

            var columnasValor = {
                Cantidad_Registro: "",
                rnc_Empresa: "",
                custpage0: "",
                custpage1: "",
                custpage2: "",
                custpage3: "",
                custpage4: "",
                custpage5: "",
                custpage6: "",
                custpage7: "",
                custpage8: "",
                custpage9: "",
                custpage10: "",
                custpage11: "",
                custpage12: "",
                custpage13: "",
                custpage14: "",
                custpage15: "",
                custpage16: "",
                custpage17: "",
                custpage18: "",
                custpage19: "",
                custpage20: "",
                custpage21: "",
                custpage22: "",
                custpage25: "",
                custpage26: "",
                custpage28: "",
                custpage29: "",
                custpage30: "",
                custpage31: "",
                custpage32: "",
                custpage33: "",
                custpage34: ""

            }


            var pagedMov = searchMov.runPaged({ pageSize: 1000 });
            var obtxt = { custpage0: "", custpage1: "" };
            pagedMov.pageRanges.forEach(function (pageRange) {
                var page = pagedMov.fetch({ index: pageRange.index });
                page.data.forEach(function (result) {
                    var cols = result.columns;
                    var colCount = 0;

                    var Retencion = true;
                    var lineaDatos = 0;
                    lineaDatos = line;
                    for (var j in columns) {



                        var lineaTexFile = 0;
                        var col = baseColumn[j];
                        var val = columns[j].type != 'select' ? result.getValue(col) : result.getText(col);
                        var colName = 'custpage' + (colCount++);
                        /**    				log.debug('colName-type-line-val', colName+'-'+columns[j].type + '-'+line+'-'+val);  */
                        if (val && val != '- None -') {
                            var text = (val.length > 300 ? val.substring(0, 296) + '...' : val);

                            if (colName == 'custpage6') { /**Fecha Retencion*/

                                var anio = text.substring(0, 4);
                                var mes = text.substring(4, 6);
                                mes = mes - 1; /**Enero empieza en 0*/
                                var dia = text.substring(6, 8);
                                var FechaRet = new Date(anio, mes, dia).toLocaleDateString(undefined, { day: '2-digit', month: '2-digit', year: 'numeric' });
                                var hastai = Date.parse(hasta)
                                var fechaReti = Date.parse(FechaRet)
                                // var monthHasta = hasta.getMonth();
                                // var monthRet = FechaRet.getMonth();
                                // log.debug('monthHasta', monthHasta);
                                // log.debug('monthRet', monthRet);
                                // log.debug('Fecha Hasta', hasta);
                                // log.debug('Fecha Reti', FechaRet);
                                if (fechaReti > hastai) {
                                    text = null;
                                    Retencion = false;
                                } else { 

                                    Retencion = true;
                                }

                            }
                            if (colName == 'custpage9') { /**ITBIS RETENIDO POR TERCEROS*/
                                if (!Retencion) {
                                    text = 0;
                                }
                            }
                            if (colName == 'custpage11') { /**RETENCION RENTA POR TERCEROS*/
                                if (!Retencion) {
                                    text = 0;
                                }
                            }

                            //Format fecha desde;

                            var montFechaDesde;
                            if (desde.length == 9) {
                                montFechaDesde = desde.substring(2, 4)
                            }
                            if (desde.length == 8) {
                                montFechaDesde = '0' + desde.substring(2, 3)
                            }


                            //Proceso para validar los datos de retencion 606;
                            if (report == '606') {
                                if (colName == 'custpage7' || colName == 'custpage8' || colName == 'custpage13' || colName == 'custpage18' || colName == 'custpage19') {
                                   
                                    var textValidacion;
                                    textValidacion = text.replace(/ /g, "");

                                    if ( textValidacion != '') {

                                        //log.debug('text', text.replace(/ /g, "").substring(4, 6));
                                        //log.debug('montFechaDesde', montFechaDesde);

                                        if (colName == 'custpage7') {

                                            fechaPago = parseInt(textValidacion.substring(4, 6));
                                        }


                                        var montDesde = montFechaDesde.replace(/ /g, "");

                                        if (fechaPago >= montDesde) {
                                            if (colName == 'custpage7' || colName == 'custpage8') {
                                                text = null;
                                            } else { 
                                                text =0;
                                            }
                                        }



                                    }
                                }
                            }

                            //Proceso para validar los datos de retencion 607;
                            if (report == '607') {
                                if (colName == 'custpage6' || colName == 'custpage9' || colName == 'custpage11') {

                                    if (text.replace(/ /g, "") != '') {

                                        // log.debug('text', text.replace(/ /g, "").substring(4, 6));
                                        // log.debug('montFechaDesde', montFechaDesde);

                                        if (colName == 'custpage6') {

                                            fechaPago = parseInt(text.replace(/ /g, "").substring(4, 6));
                                        }


                                        var montDesde = montFechaDesde.replace(/ /g, "");

                                        if (fechaPago >= montDesde) {
                                            if (colName == 'custpage6') {
                                                text =null;
                                            } else { 
                                                text =0;
                                            }

                                        }

                                           // if (fechaPago != montDesde) {
                                        //     if (colName == 'custpage6') {
                                        //         text =null;
                                        //     } else { 
                                        //         text =0;
                                        //     }

                                        // }



                                    }
                                }
                            }



                            slLineas.setSublistValue({ id: colName, line: line, value: text });

                            if(text == null)
                            {
                                text = "";
                            }


                            //Agregar RNC
                            if (colName == 'custpage0') {
                                columnasValor.custpage0 = text.toString().trim();
                            }
                            //Agregar RNC
                            if (colName == 'custpage1') {
                                columnasValor.custpage1 = parseInt(text);
                            }
                            //Agregar RNC
                            if (colName == 'custpage2') {
                                columnasValor.custpage2 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage3') {
                                columnasValor.custpage3 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage4') {
                                columnasValor.custpage4 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage5') {
                                columnasValor.custpage5 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage6') {

                                
                                log.debug('RETENCION', text)
                                columnasValor.custpage6 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage7') {
                                columnasValor.custpage7 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage8') {
                                columnasValor.custpage8 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage9') {
                                columnasValor.custpage9 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage10') {
                                columnasValor.custpage10 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage11') {
                                columnasValor.custpage11 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage12') {
                                columnasValor.custpage12 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage13') {
                                columnasValor.custpage13 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage14') {
                                columnasValor.custpage14 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage15') {
                                columnasValor.custpage15 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage16') {
                                columnasValor.custpage16 = text;
                            }

                            //Agregar RNC
                            if (colName == 'custpage17') {
                                columnasValor.custpage17 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage18') {
                                columnasValor.custpage18 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage19') {
                                columnasValor.custpage19 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage20') {
                                columnasValor.custpage20 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage21') {
                                columnasValor.custpage21 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage22') {
                                columnasValor.custpage22 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage23') {
                                columnasValor.custpage23 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage24') {
                                columnasValor.custpage24 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage25') {
                                columnasValor.custpage25 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage26') {
                                columnasValor.custpage26 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage27') {
                                columnasValor.custpage27 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage28') {
                                columnasValor.custpage28 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage29') {
                                columnasValor.custpage29 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage30') {
                                columnasValor.custpage30 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage31') {
                                columnasValor.custpage31 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage32') {
                                columnasValor.custpage32 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage33') {
                                columnasValor.custpage33 = text;
                            }
                            //Agregar RNC
                            if (colName == 'custpage34') {
                                columnasValor.custpage34 = text;
                            }


                        }


                    }
                    //Agregar datos a la lista

                    datos[line] =
                    {
                        Cantidad_Registro: columnasValor.Cantidad_Registro,
                        rnc_Empresa: columnasValor.rnc_Empresa,
                        custpage0: columnasValor.custpage0,
                        custpage1: columnasValor.custpage1,
                        custpage2: columnasValor.custpage2,
                        custpage3: columnasValor.custpage3,
                        custpage4: columnasValor.custpage4,
                        custpage5: columnasValor.custpage5,
                        custpage6: columnasValor.custpage6,
                        custpage7: columnasValor.custpage7,
                        custpage8: columnasValor.custpage8,
                        custpage9: columnasValor.custpage9,
                        custpage10: columnasValor.custpage10,
                        custpage11: columnasValor.custpage11,
                        custpage12: columnasValor.custpage12,
                        custpage13: columnasValor.custpage13,
                        custpage14: columnasValor.custpage14,
                        custpage15: columnasValor.custpage15,
                        custpage16: columnasValor.custpage16,
                        custpage17: columnasValor.custpage17,
                        custpage18: columnasValor.custpage18,
                        custpage19: columnasValor.custpage19,
                        custpage20: columnasValor.custpage20,
                        custpage21: columnasValor.custpage21,
                        custpage22: columnasValor.custpage22,
                        custpage23: columnasValor.custpage23,
                        custpage24: columnasValor.custpage24,
                        custpage25: columnasValor.custpage25,
                        custpage26: columnasValor.custpage26,
                        custpage27: columnasValor.custpage27,
                        custpage28: columnasValor.custpage28,
                        custpage29: columnasValor.custpage29,
                        custpage30: columnasValor.custpage30,
                        custpage31: columnasValor.custpage31,
                        custpage32: columnasValor.custpage32,
                        custpage33: columnasValor.custpage33,
                        custpage34: columnasValor.custpage34

                    }

                    //Limpiar Objeto;
                    columnasValor.Cantidad_Registro = '';
                    columnasValor.rnc_Empresa = '';
                    columnasValor.custpage0 = '';
                    columnasValor.custpage1 = '';
                    columnasValor.custpage2 = '';
                    columnasValor.custpage3 = '';
                    columnasValor.custpage4 = '';
                    columnasValor.custpage5 = '';
                    columnasValor.custpage6 = '';
                    columnasValor.custpage7 = '';
                    columnasValor.custpage8 = '';
                    columnasValor.custpage9 = '';
                    columnasValor.custpage10 = '';
                    columnasValor.custpage11 = '';
                    columnasValor.custpage12 = '';
                    columnasValor.custpage13 = '';
                    columnasValor.custpage14 = '';
                    columnasValor.custpage15 = '';
                    columnasValor.custpage16 = '';
                    columnasValor.custpage17 = '';
                    columnasValor.custpage18 = '';
                    columnasValor.custpage19 = '';
                    columnasValor.custpage20 = '';
                    columnasValor.custpage21 = '';
                    columnasValor.custpage22 = '';
                    columnasValor.custpage23 = '';
                    columnasValor.custpage24 = '';
                    columnasValor.custpage25 = '';
                    columnasValor.custpage26 = '';
                    columnasValor.custpage27 = '';
                    columnasValor.custpage28 = '';
                    columnasValor.custpage29 = '';
                    columnasValor.custpage30 = '';
                    columnasValor.custpage31 = '';
                    columnasValor.custpage32 = '';
                    columnasValor.custpage33 = '';
                    columnasValor.custpage34 = '';
                    fechaPago = '';
                    montDesde = '';
                    text = '';

                    line++;
                });
            });
            // var chekTXT = context.request.parameters.custpage_archivos //sw.getValue('custpage_archivos');
            var chekExcel = context.request.parameters.custpage_archivosxls //sw.getValue('custpage_archivos');


            /*   //Generar archivos txt 606
               if (chekTXT == 'T' && report == '606') {
   
                   createAndSaveFile_606(datos, report, "RNC", line, idCarpeta);
               } */

            //Generar archivos Excel 606
            if (chekExcel == 'T' && report == '606') {
                createAndSaveFile_Excel_606(datos, report, "RNC", line, idCarpeta)
            }

            //Generar archivos Excel 606
            if (chekExcel == 'T' && report == '607') {
                createAndSaveFile_Excel_607(datos, report, "RNC", line, idCarpeta)
            }

            //Generar archivos Excel 606
            if (chekExcel == 'T' && report == '608') {
                createAndSaveFile_Excel_608(datos, report, "RNC", line, idCarpeta)
            }

            //Generar archivos Excel 606
            if (chekExcel == 'T' && report == '609') {
                createAndSaveFile_Excel_609(datos, report, "RNC", line, idCarpeta)
            }






            response.writePage(form);
        }

        function getLastDateOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth(), getDaysInMonth(d));
        }

        function getFirstDateOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth(), 1);
        }

        function getDaysInMonth(d) {
            var a = [[31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31], [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]];
            var b = d.getMonth();
            return b == 1 && isLeapYear(d) ? 29 : a[isLeapYear(d) ? 1 : 0][b];
        }

        function isLeapYear(d) {
            var a = d.getFullYear();
            return !!((a & 3) == 0 && (a % 100 || (a % 400 == 0 && a)));
        }




        function createAndSaveFile_606(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var contents = tipoArchivo + '|' + obtxt[0].custpage25 + '|' + obtxt[0].custpage5 + '|' + Cantidad_Registro;
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage25 + '_' + obtxt[0].custpage5;


            var fileObj = file.create({
                name: 'DGII_F_' + Archivo + '.txt',
                fileType: file.Type.PLAINTEXT,
                contents: contents



            });

            for (var item in obtxt) {
                //Agregar una nueva linea al documento
                fileObj.appendLine({
                    value: "\n" +
                        obtxt[item].custpage0 + '|' + obtxt[item].custpage1 + '|' + obtxt[item].custpage2.substring(0, 2)
                        + '|' + obtxt[item].custpage3 + '|' + obtxt[item].custpage4 + '|' + obtxt[item].custpage5
                        + '|' + obtxt[item].custpage6 + '|' + obtxt[item].custpage7 + '|' + obtxt[item].custpage8
                        + '|' + obtxt[item].custpage9 + '|' + obtxt[item].custpage10 + '|' + obtxt[item].custpage11
                        + '|' + obtxt[item].custpage11 + '|' + obtxt[item].custpage12 + '|' + obtxt[item].custpage13
                        + '|' + obtxt[item].custpage14 + '|' + obtxt[item].custpage15 + '|' + obtxt[item].custpage16
                        + '|' + obtxt[item].custpage17 + '|' + obtxt[item].custpage18 + '|' + obtxt[item].custpage19
                        + '|' + obtxt[item].custpage20 + '|' + obtxt[item].custpage21 + '|' + obtxt[item].custpage22
                        + '|' + obtxt[item].custpage23 + '|' + obtxt[item].custpage24.substring(0, 2)

                });
            }

            fileObj.folder = idCarpeta;
            var id = fileObj.save();
            fileObj = file.load({
                id: id
            });




        }

        function createAndSaveFile_607(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var contents = tipoArchivo + '|' + obtxt[0].custpage25 + '|' + obtxt[0].custpage5 + '|' + Cantidad_Registro;
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage25 + '_' + obtxt[0].custpage5;


            var fileObj = file.create({
                name: 'DGII_F_' + Archivo + '.txt',
                fileType: file.Type.PLAINTEXT,
                contents: contents



            });

            for (var item in obtxt) {
                //Agregar una nueva linea al documento
                fileObj.appendLine({
                    value: "\n" +
                        obtxt[item].custpage0 + '|' + obtxt[item].custpage1 + '|' + obtxt[item].custpage2
                        + '|' + obtxt[item].custpage3 + '|' + obtxt[item].custpage4 + '|' + obtxt[item].custpage5
                        + '|' + obtxt[item].custpage6 + '|' + obtxt[item].custpage7 + '|' + obtxt[item].custpage8
                        + '|' + obtxt[item].custpage9 + '|' + obtxt[item].custpage10 + '|' + obtxt[item].custpage11
                        + '|' + obtxt[item].custpage11 + '|' + obtxt[item].custpage12 + '|' + obtxt[item].custpage13
                        + '|' + obtxt[item].custpage14 + '|' + obtxt[item].custpage15 + '|' + obtxt[item].custpage16
                        + '|' + obtxt[item].custpage17 + '|' + obtxt[item].custpage18 + '|' + obtxt[item].custpage19
                        + '|' + obtxt[item].custpage20 + '|' + obtxt[item].custpage21 + '|' + obtxt[item].custpage22
                    //+ '|' + obtxt[item].custpage23 + '|' + obtxt[item].custpage24

                });
            }

            fileObj.folder = idCarpeta;
            var id = fileObj.save();
            fileObj = file.load({
                id: id
            });




        }
        function createAndSaveFile_608(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var contents = tipoArchivo + '|' + obtxt[0].custpage25 + '|' + obtxt[0].custpage5 + '|' + Cantidad_Registro;
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage25 + '_' + obtxt[0].custpage5;


            var fileObj = file.create({
                name: 'DGII_F_' + Archivo + '.txt',
                fileType: file.Type.PLAINTEXT,
                contents: contents



            });

            for (var item in obtxt) {
                //Agregar una nueva linea al documento
                fileObj.appendLine({
                    value: "\n" +
                        obtxt[item].custpage0 + '|' + obtxt[item].custpage1 + '|' + obtxt[item].custpage2
                    /* + '|' + obtxt[item].custpage3 + '|' + obtxt[item].custpage4 + '|' + obtxt[item].custpage5
                     + '|' + obtxt[item].custpage6 + '|' + obtxt[item].custpage7 + '|' + obtxt[item].custpage8
                     + '|' + obtxt[item].custpage9 + '|' + obtxt[item].custpage10 + '|' + obtxt[item].custpage11
                     + '|' + obtxt[item].custpage11 + '|' + obtxt[item].custpage12 + '|' + obtxt[item].custpage13
                     + '|' + obtxt[item].custpage14 + '|' + obtxt[item].custpage15 + '|' + obtxt[item].custpage16
                     + '|' + obtxt[item].custpage17 + '|' + obtxt[item].custpage18 + '|' + obtxt[item].custpage19
                     + '|' + obtxt[item].custpage20 + '|' + obtxt[item].custpage21 + '|' + obtxt[item].custpage22
                     + '|' + obtxt[item].custpage23 + '|' + obtxt[item].custpage24*/

                });
            }

            fileObj.folder = idCarpeta;
            var id = fileObj.save();
            fileObj = file.load({
                id: id
            });




        }
        function createAndSaveFile_609(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var contents = tipoArchivo + '|' + obtxt[0].custpage25 + '|' + obtxt[0].custpage5 + '|' + Cantidad_Registro;
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage25 + '_' + obtxt[0].custpage5;


            var fileObj = file.create({
                name: 'DGII_F_' + Archivo + '.txt',
                fileType: file.Type.PLAINTEXT,
                contents: contents



            });

            for (var item in obtxt) {
                //Agregar una nueva linea al documento
                fileObj.appendLine({
                    value: "\n" +
                        obtxt[item].custpage0 + '|' + obtxt[item].custpage1 + '|' + obtxt[item].custpage2
                        + '|' + obtxt[item].custpage3 + '|' + obtxt[item].custpage4 + '|' + obtxt[item].custpage5
                        + '|' + obtxt[item].custpage6 + '|' + obtxt[item].custpage7 + '|' + obtxt[item].custpage8
                        + '|' + obtxt[item].custpage9 + '|' + obtxt[item].custpage10 + '|' + obtxt[item].custpage11
                        + '|' + obtxt[item].custpage11
                    /*+ '|' + obtxt[item].custpage12 
                    + '|' + obtxt[item].custpage13
                    + '|' + obtxt[item].custpage14 + '|' + obtxt[item].custpage15 + '|' + obtxt[item].custpage16
                    + '|' + obtxt[item].custpage17 + '|' + obtxt[item].custpage18 + '|' + obtxt[item].custpage19
                    + '|' + obtxt[item].custpage20 + '|' + obtxt[item].custpage21 + '|' + obtxt[item].custpage22
                    + '|' + obtxt[item].custpage23 + '|' + obtxt[item].custpage24*/

                });
            }

            fileObj.folder = idCarpeta;
            var id = fileObj.save();
            fileObj = file.load({
                id: id
            });




        }

        function createAndSaveFile_Excel_606(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage5;

            ///GENERAR ARCHIVO DE EXCEL; 
            var xmlStr = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xmlStr += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:o="urn:schemas-microsoft-com:office:office" ';
            xmlStr += 'xmlns:x="urn:schemas-microsoft-com:office:excel" ';
            xmlStr += 'xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:html="http://www.w3.org/TR/REC-html40">';



            xmlStr += '<Styles>'
                + ' <Style ss:ID="s17">'
                + ' <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#FFFFFF" ss:Bold="1"/>'
                + ' <Interior ss:Color="#7E7C7C" ss:Pattern="Solid"/>'
                + ' </Style>'
                + '<Style ss:ID="s63">'
                + '<Font x:CharSet="204" ss:Size="12" ss:Color="#FF0000" ss:Bold="1" ss:Underline="Single"/>'
                + '</Style>'
                + '<Style ss:ID="MyNumber">'
                + '<NumberFormat ss:Format="#,##0.00" />'
                + '</Style>'
                + '<Style ss:ID="text">'
                + '<NumberFormat ss:Format="##00" />'
                + '</Style>'
                + '<Style ss:ID="ncf">'
                + '<NumberFormat ss:Format="##00000000000" />'
                + '</Style>'
                + '</Styles>';

            xmlStr += '<Worksheet ss:Name="Sheet1">';
            xmlStr += '<Table>'
                + '<Row ss:StyleID="s17">'
      /* 1/*/ + '<Cell><Data ss:Type="String"> RNC O CÉDULA  </Data></Cell>'
      /* 2 */ + '<Cell><Data ss:Type="String"> TIPO ID  </Data></Cell>'
      /* 3 */ + '<Cell><Data ss:Type="String"> TIPO BIENES Y SERVICIOS COMPRADOS  </Data></Cell>'
      /* 4 */ + '<Cell><Data ss:Type="String"> NCF </Data></Cell>'
      /* 5 */ + '<Cell><Data ss:Type="String"> NCF O DOCUMENTO MODIFICADO </Data></Cell>'
      /* 6 */ + '<Cell><Data ss:Type="String"> FECHA DE COMPROBANTE </Data></Cell>'
      /* 7 */ + '<Cell><Data ss:Type="String"> FECHA COMPROBANTE  </Data></Cell>'
      /* 8 */ + '<Cell><Data ss:Type="String"> FECHA PAGO  </Data></Cell>'
      /* 9 */ + '<Cell><Data ss:Type="String"> FECHA PAGO </Data></Cell>'
      /* 10 */ + '<Cell><Data ss:Type="String"> MONTO FACTURADO EN SERVICIOS </Data></Cell>'
      /* 11*/ + '<Cell><Data ss:Type="String">  MONTO FACTURADO EN BIENES </Data></Cell>'

      /* 12 */ + '<Cell><Data ss:Type="String" > TOTAL MONTO FACTURADO </Data></Cell>'
      /* 13 */ + '<Cell><Data ss:Type="String"> ITBIS FACTURADO  </Data></Cell>'
      /* 14 */ + '<Cell><Data ss:Type="String"> ITBIS RETENIDO  </Data></Cell>'
      /* 15 */ + '<Cell><Data ss:Type="String"> ITBIS SUJETO A PROPORCIONALIDAD </Data></Cell>'
      /* 16 */ + '<Cell><Data ss:Type="String"> ITBIS LLEVADO AL COSTO </Data></Cell>'
      /* 17 */ + '<Cell><Data ss:Type="String"> ITBIS POR ADELANTAR </Data></Cell>'
      /* 18 */ + '<Cell><Data ss:Type="String"> ITBIS PERCIBIDO EN COMPRAS  </Data></Cell>'
      /* 19 */ + '<Cell><Data ss:Type="String"> TIPO DE RETENCIÓN EN ISR   </Data></Cell>'
      /* 20 */ + '<Cell><Data ss:Type="String"> MONTO RETENCIÓN RENTA </Data></Cell>'
      /* 21 */ + '<Cell><Data ss:Type="String"> ISR PERCIBIDO EN COMPRAS </Data></Cell>'
      /* 22 */ + '<Cell><Data ss:Type="String">  MPUESTO SELECTIVO AL CONSUMO </Data></Cell>'

      /* 23 */ + '<Cell><Data ss:Type="String"> OTROS IMPUESTOS/ TASAS </Data></Cell>'
      /* 24 */ + '<Cell><Data ss:Type="String"> MONTO PROPINA LEGAL  </Data></Cell>'
      /* 25 */ + '<Cell><Data ss:Type="String"> FORMA DE PAGO   </Data></Cell>'

                + '</Row>';


            for (var item in obtxt) {

                xmlStr += '<Row>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage0.replace(/ /g, "") + '</Data></Cell>'
                    + '<Cell><Data ss:Type="Number">' + obtxt[item].custpage1 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage2 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage3 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage4 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage5 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage6 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage7 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage8 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage9 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage10 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage11 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage12 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage13 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage14 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage15 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage16 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage17 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage18 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage19 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage20 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage21 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage22 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage23 + '</Data></Cell>'

                    + '<Cell> <Data ss:Type="String">' + obtxt[item].custpage24 + '</Data></Cell>'

                    + '</Row>';

            }


            xmlStr += '</Table></Worksheet></Workbook>';

            log.debug("Datos", xmlStr);
            
            var strXmlEncoded = encode.convert({
                string: xmlStr,
                inputEncoding: encode.Encoding.UTF_8,
                outputEncoding: encode.Encoding.BASE_64
            });

            var objXlsFile = file.create({
                name: 'DGII_F_' + Archivo + '.xls',
                fileType: file.Type.EXCEL,
                contents: strXmlEncoded
            });


            //Optional: you can choose to save it to file cabinet
            objXlsFile.folder = idCarpeta;
            var intFileId = objXlsFile.save();







        }


        function createAndSaveFile_Excel_607(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage5;

            ///GENERAR ARCHIVO DE EXCEL; 
            var xmlStr = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xmlStr += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:o="urn:schemas-microsoft-com:office:office" ';
            xmlStr += 'xmlns:x="urn:schemas-microsoft-com:office:excel" ';
            xmlStr += 'xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:html="http://www.w3.org/TR/REC-html40">';



            xmlStr += '<Styles>'
                + ' <Style ss:ID="s17">'
                + ' <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#FFFFFF" ss:Bold="1"/>'
                + ' <Interior ss:Color="#7E7C7C" ss:Pattern="Solid"/>'
                + ' </Style>'
                + '<Style ss:ID="s63">'
                + '<Font x:CharSet="204" ss:Size="12" ss:Color="#FF0000" ss:Bold="1" ss:Underline="Single"/>'
                + '</Style>'
                + '<Style ss:ID="MyNumber">'
                + '<NumberFormat ss:Format="#,##0.00" />'
                + '</Style>'
                + '<Style ss:ID="text">'
                + '<NumberFormat ss:Format="##00" />'
                + '</Style>'
                + '<Style ss:ID="ncf">'
                + '<NumberFormat ss:Format="##00000000000" />'
                + '</Style>'
                + '</Styles>';

            xmlStr += '<Worksheet ss:Name="Sheet1">';
            xmlStr += '<Table>'
                + '<Row ss:StyleID="s17">'
           /*1*/ + '<Cell><Data ss:Type="String"> RNC , CÉDULA O PASAPORTE  </Data></Cell>'
           /*2*/ + '<Cell><Data ss:Type="String"> TIPO IDENTIFICACIÓN   </Data></Cell>'
           /*3*/ + '<Cell><Data ss:Type="String"> NÚMERO COMPROBANTE FISCAL   </Data></Cell>'
           /*4*/ + '<Cell><Data ss:Type="String"> NUMERO COMPROBANTE MODIFICADO  </Data></Cell>'
           /*5*/ + '<Cell><Data ss:Type="String"> TIPO DE INGRESO </Data></Cell>'
           /*6*/ + '<Cell><Data ss:Type="String"> FECHA COMPROBANTE  </Data></Cell>'
           /*7*/ + '<Cell><Data ss:Type="String"> FECHA DE RETENCIÓN  </Data></Cell>'
           /*8*/ + '<Cell><Data ss:Type="String"> MONTO FACTURADO </Data></Cell>'
           /*9*/ + '<Cell><Data ss:Type="String">  ITBIS FACTURADO </Data></Cell>'
          /*10*/ + '<Cell><Data ss:Type="String"> ITBIS RETENIDO POR TERCEROS </Data></Cell>'
          /*11*/ + '<Cell><Data ss:Type="String"> ITBIS PERCIBIDO </Data></Cell>'

           /*12*/ + '<Cell><Data ss:Type="String" > RETENCIÓN RENTA POR TERCEROS </Data></Cell>'
           /*13*/ + '<Cell><Data ss:Type="String"> ISR PERCIBIDO </Data></Cell>'
           /*14*/ + '<Cell><Data ss:Type="String">  IMPUESTO SELECTIVO AL CONSUMO  </Data></Cell>'
           /*15*/ + '<Cell><Data ss:Type="String">  OTROS IMPUESTOS/TASAS </Data></Cell>'
           /*16*/ + '<Cell><Data ss:Type="String"> MONTO PROPINA LEGAL </Data></Cell>'
           /*17*/ + '<Cell><Data ss:Type="String">  EFECTIVO </Data></Cell>'
           /*18*/ + '<Cell><Data ss:Type="String">  CHEQUE/TRANSFERENCIA/DEPÓSITO  </Data></Cell>'
           /*19*/ + '<Cell><Data ss:Type="String">  TARJETA DÉBITO/CRÉDITO   </Data></Cell>'
           /*20*/ + '<Cell><Data ss:Type="String">  VENTA A CRÉDITO </Data></Cell>'
           /*21*/ + '<Cell><Data ss:Type="String"> BONOS O CERTIFICADOS DE REGALO </Data></Cell>'
           /*22*/ + '<Cell><Data ss:Type="String"> PERMUTA </Data></Cell>'
           /*23*/ + '<Cell><Data ss:Type="String"> OTRAS FORMAS DE VENTAS </Data></Cell>'

                + '</Row>';


            for (var item in obtxt) {

                xmlStr += '<Row>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage0.replace(/ /g, "") + '</Data></Cell>'
                    + '<Cell><Data ss:Type="Number">' + obtxt[item].custpage1 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage2 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage3 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="Number">' + obtxt[item].custpage4.substring(1, 2) + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage5 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage6 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage7 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage8 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage10 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage9 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage11 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage12 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage13 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage14 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage15 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage16 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage17 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage18 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage19 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage20 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage21 + '</Data></Cell>'
                    + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage22 + '</Data></Cell>'


                    + '</Row>';

            }


            xmlStr += '</Table></Worksheet></Workbook>';

            var strXmlEncoded = encode.convert({
                string: xmlStr,
                inputEncoding: encode.Encoding.UTF_8,
                outputEncoding: encode.Encoding.BASE_64
            });

            var objXlsFile = file.create({
                name: 'DGII_F_' + Archivo + '.xls',
                fileType: file.Type.EXCEL,
                contents: strXmlEncoded
            });


            //Optional: you can choose to save it to file cabinet
            objXlsFile.folder = idCarpeta;
            var intFileId = objXlsFile.save();


        }


        function createAndSaveFile_Excel_608(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage5;

            ///GENERAR ARCHIVO DE EXCEL; 
            var xmlStr = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xmlStr += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:o="urn:schemas-microsoft-com:office:office" ';
            xmlStr += 'xmlns:x="urn:schemas-microsoft-com:office:excel" ';
            xmlStr += 'xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:html="http://www.w3.org/TR/REC-html40">';



            xmlStr += '<Styles>'
                + ' <Style ss:ID="s17">'
                + ' <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#FFFFFF" ss:Bold="1"/>'
                + ' <Interior ss:Color="#7E7C7C" ss:Pattern="Solid"/>'
                + ' </Style>'
                + '<Style ss:ID="s63">'
                + '<Font x:CharSet="204" ss:Size="12" ss:Color="#FF0000" ss:Bold="1" ss:Underline="Single"/>'
                + '</Style>'
                + '<Style ss:ID="MyNumber">'
                + '<NumberFormat ss:Format="#,##0.00" />'
                + '</Style>'
                + '<Style ss:ID="text">'
                + '<NumberFormat ss:Format="##00" />'
                + '</Style>'
                + '<Style ss:ID="ncf">'
                + '<NumberFormat ss:Format="##00000000000" />'
                + '</Style>'
                + '</Styles>';

            xmlStr += '<Worksheet ss:Name="Sheet1">';
            xmlStr += '<Table>'
                + '<Row ss:StyleID="s17">'
           /*1*/ + '<Cell><Data ss:Type="String"> NÚMERO COMPROBANTE FISCAL   </Data></Cell>'
           /*2*/ + '<Cell><Data ss:Type="String"> FECHA COMPROBANTE    </Data></Cell>'
           /*3*/ + '<Cell><Data ss:Type="String"> TIPO DE ANULACIÓN    </Data></Cell>'

                + '</Row>';


            for (var item in obtxt) {

                xmlStr += '<Row>'
                    + '<Cell><Data ss:Type="String"> ' + obtxt[item].custpage0 + ' </Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage1 + '</Data></Cell>'
                    + '<Cell><Data ss:Type="String">' + obtxt[item].custpage2 + '</Data></Cell>'


                    + '</Row>';

            }


            xmlStr += '</Table></Worksheet></Workbook>';

            var strXmlEncoded = encode.convert({
                string: xmlStr,
                inputEncoding: encode.Encoding.UTF_8,
                outputEncoding: encode.Encoding.BASE_64
            });

            var objXlsFile = file.create({
                name: 'DGII_F_' + Archivo + '.xls',
                fileType: file.Type.EXCEL,
                contents: strXmlEncoded
            });


            //Optional: you can choose to save it to file cabinet
            objXlsFile.folder = idCarpeta;
            var intFileId = objXlsFile.save();


        }


        function createAndSaveFile_Excel_609(obtxt, tipoArchivo, rnc_Empresa, Cantidad_Registro, idCarpeta) {

            if (obtxt.length == 0)
                return
            var Archivo = tipoArchivo + '_' + obtxt[0].custpage5;

            ///GENERAR ARCHIVO DE EXCEL; 
            var xmlStr = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xmlStr += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:o="urn:schemas-microsoft-com:office:office" ';
            xmlStr += 'xmlns:x="urn:schemas-microsoft-com:office:excel" ';
            xmlStr += 'xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" ';
            xmlStr += 'xmlns:html="http://www.w3.org/TR/REC-html40">';



            xmlStr += '<Styles>'
                + ' <Style ss:ID="s17">'
                + ' <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#FFFFFF" ss:Bold="1"/>'
                + ' <Interior ss:Color="#7E7C7C" ss:Pattern="Solid"/>'
                + ' </Style>'
                + '<Style ss:ID="s63">'
                + '<Font x:CharSet="204" ss:Size="12" ss:Color="#FF0000" ss:Bold="1" ss:Underline="Single"/>'
                + '</Style>'
                + '<Style ss:ID="MyNumber">'
                + '<NumberFormat ss:Format="#,##0.00" />'
                + '</Style>'
                + '<Style ss:ID="text">'
                + '<NumberFormat ss:Format="##00" />'
                + '</Style>'
                + '<Style ss:ID="ncf">'
                + '<NumberFormat ss:Format="##00000000000" />'
                + '</Style>'
                + '</Styles>';

            xmlStr += '<Worksheet ss:Name="Sheet1">';
            xmlStr += '<Table>'
                + '<Row ss:StyleID="s17">'
           /*1*/ + '<Cell><Data ss:Type="String"> NOMBRE / RAZÓN SOCIAL </Data></Cell>'
           /*2*/ + '<Cell><Data ss:Type="String"> TIPO ID TRIBUTARIA  </Data></Cell>'
           /*3*/ + '<Cell><Data ss:Type="String"> ID TRIBUTARIA  </Data></Cell>'
           /*4*/ + '<Cell><Data ss:Type="String"> PAÍS DE DESTINO  </Data></Cell>'
           /*5*/ + '<Cell><Data ss:Type="String"> TIPO DE SERVICIOS ADQUIRIDOS  </Data></Cell>'
           /*6*/ + '<Cell><Data ss:Type="String"> DETALLE DEL SERVICIO ADQUIRIDO </Data></Cell>'
           /*7*/ + '<Cell><Data ss:Type="String"> PARTE RELACIONADA  </Data></Cell>'
           /*8*/ + '<Cell><Data ss:Type="String"> NÚMERO DE DOCUMENTO  </Data></Cell>'
           /*9*/ + '<Cell><Data ss:Type="String">  FECHA DE DOCUMENTO  </Data></Cell>'
          /*10*/ + '<Cell><Data ss:Type="String">  MONTO FACTURADO </Data></Cell>'
          /*11*/ + '<Cell><Data ss:Type="String"> FECHA DE RETENCIÓN ISR  </Data></Cell>'

           /*12*/ + '<Cell><Data ss:Type="String" > RENTA PRESUNTA </Data></Cell>'
           /*13*/ + '<Cell><Data ss:Type="String">  ISR RETENIDO </Data></Cell>'

                + '</Row>';


            for (var item in obtxt) {

                xmlStr += '<Row>'

           /*1*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage0 + '</Data></Cell>'
           /*2*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage1 + '</Data></Cell>'
           /*3*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage2 + '</Data></Cell>'
           /*4*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage3 + '</Data></Cell>'
           /*5*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage4 + '</Data></Cell>'
           /*6*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage5 + '</Data></Cell>'
           /*7*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage6 + '</Data></Cell>'
           /*8*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage7 + '</Data></Cell>'
           /*9*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage8 + '</Data></Cell>'
           /*10*/ + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage10 + '</Data></Cell>'
           /*11*/ + '<Cell><Data ss:Type="String">' + obtxt[item].custpage9 + '</Data></Cell>'
           /*12*/ + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage11 + '</Data></Cell>'
           /*13*/ + '<Cell ss:StyleID="MyNumber"><Data ss:Type="Number">' + obtxt[item].custpage12 + '</Data></Cell>'


                    + '</Row>';

            }


            xmlStr += '</Table></Worksheet></Workbook>';

            var strXmlEncoded = encode.convert({
                string: xmlStr,
                inputEncoding: encode.Encoding.UTF_8,
                outputEncoding: encode.Encoding.BASE_64
            });

            var objXlsFile = file.create({
                name: 'DGII_F_' + Archivo + '.xls',
                fileType: file.Type.EXCEL,
                contents: strXmlEncoded
            });


            //Optional: you can choose to save it to file cabinet
            objXlsFile.folder = idCarpeta;
            var intFileId = objXlsFile.save();


        }

        return {
            onRequest: onRequest

        }

    });

